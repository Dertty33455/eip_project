// Prisma Schema for AfriBook Platform
// Base de données relationnelle complète

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// UTILISATEURS & AUTHENTIFICATION
// ============================================

enum UserRole {
  USER
  SELLER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
}

model User {
  id                String      @id @default(cuid())
  email             String      @unique
  phone             String?     @unique
  password          String
  firstName         String
  lastName          String
  username          String      @unique
  avatar            String?
  bio               String?
  location          String?
  country           String?
  role              UserRole    @default(USER)
  status            UserStatus  @default(PENDING_VERIFICATION)
  isVerifiedSeller  Boolean     @default(false)
  isEmailVerified   Boolean     @default(false)
  isPhoneVerified   Boolean     @default(false)
  lastLoginAt       DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  wallet            Wallet?
  posts             Post[]
  comments          Comment[]
  likes             Like[]
  booksSelling      Book[]              @relation("SellerBooks")
  booksPurchased    Order[]             @relation("BuyerOrders")
  ordersSold        Order[]             @relation("SellerOrders")
  reviews           Review[]            @relation("ReviewAuthor")
  reviewsReceived   Review[]            @relation("ReviewTarget")
  notifications     Notification[]
  favorites         Favorite[]
  audioProgress     AudioProgress[]
  subscriptions     Subscription[]
  reports           Report[]            @relation("ReportAuthor")
  reportsReceived   Report[]            @relation("ReportTarget")
  followers         Follow[]            @relation("Following")
  following         Follow[]            @relation("Followers")
  messages          Message[]           @relation("MessageSender")
  messagesReceived  Message[]           @relation("MessageReceiver")
  conversations     ConversationParticipant[]
  sessions          Session[]
  verificationTokens VerificationToken[]

  @@index([email])
  @@index([phone])
  @@index([username])
  @@index([role])
  @@index([status])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  userAgent    String?
  ipAddress    String?
  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model VerificationToken {
  id         String   @id @default(cuid())
  userId     String
  token      String   @unique
  type       String   // EMAIL, PHONE, PASSWORD_RESET
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

// ============================================
// WALLET & PAIEMENTS MOBILE MONEY
// ============================================

enum TransactionType {
  DEPOSIT           // Recharge
  WITHDRAWAL        // Retrait
  PURCHASE          // Achat livre
  SALE              // Vente livre
  SUBSCRIPTION      // Abonnement audio
  COMMISSION        // Commission plateforme
  REFUND            // Remboursement
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentProvider {
  MTN_MOMO
  MOOV_MONEY
  WALLET
}

model Wallet {
  id              String        @id @default(cuid())
  userId          String        @unique
  balance         Decimal       @default(0) @db.Decimal(12, 2)
  currency        String        @default("XOF")
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions    Transaction[]

  @@index([userId])
}

model Transaction {
  id                String            @id @default(cuid())
  walletId          String
  type              TransactionType
  status            TransactionStatus @default(PENDING)
  amount            Decimal           @db.Decimal(12, 2)
  fee               Decimal           @default(0) @db.Decimal(12, 2)
  netAmount         Decimal           @db.Decimal(12, 2)
  currency          String            @default("XOF")
  provider          PaymentProvider?
  providerRef       String?           // Référence externe MTN/Moov
  description       String?
  metadata          Json?
  orderId           String?
  subscriptionId    String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  wallet            Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)
  order             Order?            @relation(fields: [orderId], references: [id])
  subscription      Subscription?     @relation(fields: [subscriptionId], references: [id])

  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([providerRef])
  @@index([createdAt])
}

// ============================================
// LIVRES & MARKETPLACE
// ============================================

enum BookCondition {
  NEW
  LIKE_NEW
  VERY_GOOD
  GOOD
  ACCEPTABLE
}

enum BookStatus {
  DRAFT
  ACTIVE
  SOLD
  RESERVED
  ARCHIVED
}

model Category {
  id          String     @id @default(cuid())
  name        String     @unique
  slug        String     @unique
  description String?
  icon        String?
  image       String?
  parentId    String?
  isActive    Boolean    @default(true)
  order       Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  parent      Category?  @relation("CategoryChildren", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryChildren")
  books       Book[]
  audiobooks  Audiobook[]

  @@index([slug])
  @@index([parentId])
}

model Book {
  id            String        @id @default(cuid())
  title         String
  author        String
  isbn          String?
  description   String        @db.Text
  price         Decimal       @db.Decimal(10, 2)
  originalPrice Decimal?      @db.Decimal(10, 2)
  condition     BookCondition
  status        BookStatus    @default(DRAFT)
  quantity      Int           @default(1)
  location      String?
  city          String?
  country       String?
  images        String[]      // Array d'URLs
  coverImage    String?
  language      String        @default("Français")
  publishedYear Int?
  pages         Int?
  weight        Decimal?      @db.Decimal(6, 2)
  viewCount     Int           @default(0)
  sellerId      String
  categoryId    String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  seller        User          @relation("SellerBooks", fields: [sellerId], references: [id], onDelete: Cascade)
  category      Category      @relation(fields: [categoryId], references: [id])
  orderItems    OrderItem[]
  reviews       Review[]
  favorites     Favorite[]
  cartItems     CartItem[]

  @@index([title])
  @@index([author])
  @@index([sellerId])
  @@index([categoryId])
  @@index([status])
  @@index([condition])
  @@index([price])
  @@index([createdAt])
  @@fulltext([title, author, description])
}

// ============================================
// COMMANDES & LIVRAISON
// ============================================

enum OrderStatus {
  PENDING
  PAID
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum DeliveryType {
  SHIPPING
  LOCAL_PICKUP
}

model Order {
  id                String        @id @default(cuid())
  orderNumber       String        @unique
  buyerId           String
  sellerId          String
  status            OrderStatus   @default(PENDING)
  subtotal          Decimal       @db.Decimal(12, 2)
  commission        Decimal       @db.Decimal(12, 2) // 5% plateforme
  sellerAmount      Decimal       @db.Decimal(12, 2) // 95% vendeur
  deliveryFee       Decimal       @default(0) @db.Decimal(10, 2)
  totalAmount       Decimal       @db.Decimal(12, 2)
  currency          String        @default("XOF")
  deliveryType      DeliveryType  @default(SHIPPING)
  deliveryAddress   String?
  deliveryCity      String?
  deliveryCountry   String?
  deliveryPhone     String?
  trackingNumber    String?
  notes             String?
  paidAt            DateTime?
  shippedAt         DateTime?
  deliveredAt       DateTime?
  cancelledAt       DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  buyer             User          @relation("BuyerOrders", fields: [buyerId], references: [id])
  seller            User          @relation("SellerOrders", fields: [sellerId], references: [id])
  items             OrderItem[]
  transactions      Transaction[]
  invoice           Invoice?

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  bookId      String
  quantity    Int      @default(1)
  price       Decimal  @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())

  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  book        Book     @relation(fields: [bookId], references: [id])

  @@index([orderId])
  @@index([bookId])
}

model Cart {
  id        String     @id @default(cuid())
  sessionId String     @unique
  userId    String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  items     CartItem[]

  @@index([sessionId])
  @@index([userId])
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  bookId    String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([cartId, bookId])
  @@index([cartId])
  @@index([bookId])
}

model Invoice {
  id            String   @id @default(cuid())
  orderId       String   @unique
  invoiceNumber String   @unique
  pdfUrl        String?
  createdAt     DateTime @default(now())

  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([invoiceNumber])
}

// ============================================
// LIVRES AUDIO & ABONNEMENTS
// ============================================

enum AudiobookStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Audiobook {
  id            String          @id @default(cuid())
  title         String
  author        String
  narrator      String?
  description   String          @db.Text
  coverImage    String?
  totalDuration Int             @default(0) // En secondes
  language      String          @default("Français")
  publishedYear Int?
  isPopular     Boolean         @default(false)
  isFeatured    Boolean         @default(false)
  status        AudiobookStatus @default(DRAFT)
  playCount     Int             @default(0)
  categoryId    String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  category      Category        @relation(fields: [categoryId], references: [id])
  chapters      AudioChapter[]
  progress      AudioProgress[]
  favorites     Favorite[]
  reviews       Review[]

  @@index([title])
  @@index([author])
  @@index([categoryId])
  @@index([status])
  @@index([isPopular])
  @@fulltext([title, author, description])
}

model AudioChapter {
  id            String          @id @default(cuid())
  audiobookId   String
  title         String
  chapterNumber Int
  duration      Int             // En secondes
  audioUrl      String
  isFree        Boolean         @default(false) // Premier chapitre gratuit
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  audiobook     Audiobook       @relation(fields: [audiobookId], references: [id], onDelete: Cascade)
  progress      AudioProgress[]

  @@unique([audiobookId, chapterNumber])
  @@index([audiobookId])
}

model AudioProgress {
  id          String       @id @default(cuid())
  userId      String
  audiobookId String
  chapterId   String
  position    Int          @default(0) // Position en secondes
  completed   Boolean      @default(false)
  speed       Float        @default(1.0)
  updatedAt   DateTime     @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  audiobook   Audiobook    @relation(fields: [audiobookId], references: [id], onDelete: Cascade)
  chapter     AudioChapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@unique([userId, audiobookId, chapterId])
  @@index([userId])
  @@index([audiobookId])
}

enum SubscriptionPlan {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING
}

model Subscription {
  id              String             @id @default(cuid())
  userId          String
  plan            SubscriptionPlan
  status          SubscriptionStatus @default(PENDING)
  price           Decimal            @db.Decimal(10, 2)
  currency        String             @default("XOF")
  startDate       DateTime?
  endDate         DateTime?
  cancelledAt     DateTime?
  autoRenew       Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions    Transaction[]

  @@index([userId])
  @@index([status])
  @@index([endDate])
}

model SubscriptionPricing {
  id        String           @id @default(cuid())
  plan      SubscriptionPlan @unique
  price     Decimal          @db.Decimal(10, 2)
  currency  String           @default("XOF")
  duration  Int              // En jours
  isActive  Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
}

// ============================================
// RÉSEAU SOCIAL - POSTS & INTERACTIONS
// ============================================

enum PostType {
  TEXT
  IMAGE
  REVIEW
  RECOMMENDATION
}

model Post {
  id          String    @id @default(cuid())
  authorId    String
  type        PostType  @default(TEXT)
  content     String    @db.Text
  images      String[]  // Array d'URLs
  bookTitle   String?   // Pour les recommandations
  bookAuthor  String?
  rating      Int?      // 1-5 pour les avis
  isPublished Boolean   @default(true)
  isReported  Boolean   @default(false)
  viewCount   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments    Comment[]
  likes       Like[]
  shares      Share[]
  reports     Report[]

  @@index([authorId])
  @@index([type])
  @@index([isPublished])
  @@index([createdAt])
  @@fulltext([content])
}

model Comment {
  id          String    @id @default(cuid())
  postId      String
  authorId    String
  content     String    @db.Text
  parentId    String?   // Pour les réponses
  isReported  Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  post        Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent      Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies     Comment[] @relation("CommentReplies")
  likes       Like[]
  reports     Report[]

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  postId    String?
  commentId String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@unique([userId, commentId])
  @@index([postId])
  @@index([commentId])
}

model Share {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  platform  String?  // facebook, twitter, whatsapp, copy
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower    User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ============================================
// AVIS & NOTATIONS
// ============================================

enum ReviewType {
  BOOK
  AUDIOBOOK
  SELLER
}

model Review {
  id          String     @id @default(cuid())
  authorId    String
  type        ReviewType
  bookId      String?
  audiobookId String?
  sellerId    String?    // Pour noter un vendeur
  rating      Int        // 1-5
  title       String?
  content     String     @db.Text
  isVerified  Boolean    @default(false) // Achat vérifié
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  author      User       @relation("ReviewAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  book        Book?      @relation(fields: [bookId], references: [id], onDelete: Cascade)
  audiobook   Audiobook? @relation(fields: [audiobookId], references: [id], onDelete: Cascade)
  seller      User?      @relation("ReviewTarget", fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([bookId])
  @@index([audiobookId])
  @@index([sellerId])
  @@index([type])
}

// ============================================
// FAVORIS & LISTES
// ============================================

enum FavoriteType {
  BOOK
  AUDIOBOOK
}

model Favorite {
  id          String       @id @default(cuid())
  userId      String
  type        FavoriteType
  bookId      String?
  audiobookId String?
  createdAt   DateTime     @default(now())

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  book        Book?        @relation(fields: [bookId], references: [id], onDelete: Cascade)
  audiobook   Audiobook?   @relation(fields: [audiobookId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@unique([userId, audiobookId])
  @@index([userId])
  @@index([type])
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  WALLET_DEPOSIT
  WALLET_WITHDRAWAL
  ORDER_PLACED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  SALE_MADE
  NEW_MESSAGE
  NEW_COMMENT
  NEW_LIKE
  NEW_FOLLOWER
  NEW_CHAPTER
  SUBSCRIPTION_EXPIRING
  SYSTEM
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now())

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================
// MESSAGERIE
// ============================================

model Conversation {
  id           String                    @id @default(cuid())
  lastMessage  String?
  lastActivity DateTime                  @default(now())
  createdAt    DateTime                  @default(now())

  participants ConversationParticipant[]
  messages     Message[]

  @@index([lastActivity])
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  userId         String
  lastReadAt     DateTime?
  createdAt      DateTime     @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  receiverId     String
  content        String       @db.Text
  images         String[]
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver       User         @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([receiverId])
}

// ============================================
// SIGNALEMENTS & MODÉRATION
// ============================================

enum ReportReason {
  SPAM
  INAPPROPRIATE
  HARASSMENT
  FAKE
  COPYRIGHT
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

model Report {
  id          String       @id @default(cuid())
  reporterId  String
  targetId    String?      // User being reported
  postId      String?
  commentId   String?
  reason      ReportReason
  description String?      @db.Text
  status      ReportStatus @default(PENDING)
  resolvedBy  String?
  resolvedAt  DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  reporter    User         @relation("ReportAuthor", fields: [reporterId], references: [id], onDelete: Cascade)
  target      User?        @relation("ReportTarget", fields: [targetId], references: [id], onDelete: Cascade)
  post        Post?        @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment     Comment?     @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([reporterId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// PARAMÈTRES PLATEFORME
// ============================================

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  type      String   @default("string") // string, number, boolean, json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

// ============================================
// ANALYTICS & STATISTIQUES
// ============================================

model Analytics {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  metric    String   // total_users, total_orders, total_revenue, etc.
  value     Decimal  @db.Decimal(14, 2)
  metadata  Json?
  createdAt DateTime @default(now())

  @@unique([date, metric])
  @@index([date])
  @@index([metric])
}
